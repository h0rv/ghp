# ghp — MVP Spec (Go) for GitHub Projects (v2) Terminal UI

## Goal
Build a usable terminal UI (TUI) focused on **GitHub Projects v2** that lets a user:
1) authenticate,
2) pick an owner + project,
3) view the project as a kanban-style board grouped by a single-select field (usually “Status”),
4) move items between columns (by updating that field),
5) open the underlying Issue/PR/Draft item in a browser,
6) filter by text,
7) refresh manually,
with pagination and sane error handling.

This MVP is intentionally opinionated and does **not** attempt to replicate GitHub’s saved views or board layout.

---

## Non-Goals (explicitly out of scope for MVP)
- Editing arbitrary fields besides the grouping single-select field
- Creating/deleting projects or items
- Supporting GitHub Projects classic (v1)
- Real-time sync / subscriptions
- Replicating GitHub UI layout or saved views/filters/sorts
- Drag-and-drop; we use keyboard-driven “move”

---

## User Experience Requirements

### Primary flow
1. User runs: `ghp`
2. Tool obtains a token:
   - Preferred: `gh auth token`
   - Fallback: `GITHUB_TOKEN` env var
   - If neither available: print a clear error and exit with non-zero
3. Determine owner:
   - If `--owner` is provided, use it
   - Else prompt user for owner login (org or user)
4. List projects for owner → user selects a project from a list
5. Load project schema (fields + options)
6. Choose grouping field:
   - Auto-pick: field name equals “Status” (case-insensitive) and type SINGLE_SELECT
   - Else if exactly one SINGLE_SELECT field exists, pick it
   - Else prompt user to choose a SINGLE_SELECT field
   - If none exist: show message and exit (MVP)
7. Show board view:
   - Columns are options for the grouping field
   - Include a “No Status” column for items missing the field value
   - Cards show minimal info: title, plus (repo#number) if issue/PR, else “(draft)” or “(private)”
8. Navigation:
   - left/right switches columns
   - up/down moves selection within column
   - `m` move item: choose a destination column (option) and apply mutation
   - `o` open item URL in browser
   - `/` filter (client-side substring match on title)
   - `r` refresh items (manual)
   - `g` change grouping field (returns to grouping-field picker)
   - `?` help overlay (keymap)
   - `q` quit

### Move behavior
- Optimistic UI: update board immediately, then run mutation.
- On mutation failure: rollback the move and show a non-fatal error toast/banner.

### Pagination
- Fetch items in pages (50 recommended).
- Allow “Load more”:
  - Either auto-load when scrolling near end, or a key like `L`.
- The board should remain responsive while loading:
  - show a spinner/loading indicator in status bar.

### Error handling (must-haves)
- If owner login not found or user lacks access: show clear message.
- If project fields changed (mutation fails due to invalid option/field): refetch schema and re-prompt for grouping field.
- If token is missing/invalid: show actionable guidance.
- If item content is null/unknown due to permissions: render as “(private item)” with limited actions (disable open if URL missing).

---

## Technical Requirements

### Language & libraries
Use **Go**.

Install/Use:
- `github.com/charmbracelet/bubbletea` (TUI state machine)
- `github.com/charmbracelet/lipgloss` (styling)
- `github.com/charmbracelet/bubbles` (list/textinput/help/spinner components)
- `github.com/spf13/cobra` (CLI flags/subcommands) OR Go `flag` package (Cobra preferred)
- `github.com/machinebox/graphql` OR implement minimal GraphQL client using `net/http` (either acceptable)
- `github.com/pkg/browser` (open URLs in default browser)
- `github.com/stretchr/testify` (tests)

Tooling:
- `goreleaser` config is nice-to-have, not required for MVP.

### Compatibility
- Runs on macOS + Linux
- Windows: best-effort; browser open might differ (pkg/browser helps)

---

## Project Structure
Recommended:
- `cmd/ghproj/main.go` — entrypoint
- `internal/auth/` — token providers
- `internal/gh/` — GitHub GraphQL client + queries/mutations
- `internal/domain/` — normalized types (Project, FieldDef, Card, etc.)
- `internal/store/` — in-memory state, grouping logic, caching
- `internal/tui/` — Bubble Tea models, screens, keymaps, rendering

---

## Domain Model (normalized)
Define types roughly like:

- `Project { ID string; Number int; Title string; Owner string }`
- `FieldDef { ID string; Name string; Type string; Options []Option }`
- `Option { ID string; Name string }`
- `Card { ItemID string; ContentType string; Title string; URL string; Repo string; Number int; GroupOptionID string }`

Rules:
- `Repo` and `Number` only apply to Issue/PR.
- For draft/private items, `Repo` and `Number` may be empty/zero; `URL` may be empty.

Store should keep:
- current project + group field
- all loaded cards (map by ItemID)
- column mapping: optionID → []ItemID plus a special bucket for empty group value
- cursor for pagination + `hasNextPage`

---

## GitHub API Notes (Projects v2)
MVP must target Projects v2 via **GraphQL**.

### Required queries/mutations

#### 1) Determine owner type (org vs user)
Implement a query to resolve the login and type; or attempt org then user.
Either approach is acceptable, but must handle both.

#### 2) List projects for an owner
Return project `id`, `number`, `title`.

#### 3) Get project fields (schema)
Fetch fields with:
- field id
- name
- type
- for SINGLE_SELECT, fetch options (id + name)

#### 4) Get items paged
Fetch items: `first: 50`, `after: cursor`.
For each item:
- `id`
- `content` union:
  - Issue: title, url, number, repository{nameWithOwner}
  - PullRequest: title, url, number, repository{nameWithOwner}
- DraftIssue: title (and maybe url if available)
- Also fetch **only** the grouping field value:
  - `fieldValueByName(name: "<group field name>")` or by field id if possible
  - extract option ID for SINGLE_SELECT values

Keep the items query thin—do not fetch all field values.

#### 5) Move item (update field value)
Use `updateProjectV2ItemFieldValue` mutation:
- inputs: projectID, itemID, fieldID, value (optionID)
- On success, nothing else needed.

---

## UI Screens (Bubble Tea models)
- `OwnerPromptModel` (optional if --owner present)
- `ProjectPickerModel` (bubbles/list)
- `GroupFieldPickerModel` (bubbles/list)
- `BoardModel` (custom rendering with lipgloss)
- `HelpOverlay` (bubbles/help)

Board rendering:
- columns with headers showing option name + count
- selected column highlighted
- selected card highlighted
- status bar: owner/project/groupField, filter text, loading/error toasts

---

## Keybindings (MVP)
- `q` quit
- `?` help overlay
- `h/l` or left/right: switch columns
- `j/k` or up/down: move selection
- `m`: move selected card → column picker (options list)
- `o`: open selected card URL in browser (if exists)
- `/`: enter filter mode (textinput); `enter` applies, `esc` cancels
- `r`: refresh (refetch first page, reset pagination; preserve group field)
- `L`: load more (optional if not auto-loading)
- `g`: change grouping field (back to field picker)

---

## Rough Edges & Required Design Workarounds
1. “Board layout” isn’t an API primitive → Board is an opinionated grouping by one SINGLE_SELECT field.
2. Project schemas are dynamic → must discover fields and options at runtime.
3. Item content types vary → normalize Issue/PR vs Draft/Private and render safely.
4. Pagination and cost limits → incremental fetch, cache schema, thin queries.
5. Mutation failure handling → optimistic update + rollback + toast.

---

## Deliverables
1. Working `ghproj` binary with the MVP flow above.
2. README with:
   - install instructions (`go install ...`)
   - auth requirements (`gh auth login` or `GITHUB_TOKEN`)
   - usage examples
3. Minimal tests:
   - store grouping logic (cards → columns)
   - group field auto-selection heuristic

---

## CLI Interface
`ghproj [--owner <login>] [--project <number>] [--group-field <name>]`

Behavior:
- If `--project` and `--group-field` are provided, go straight to board (still fetch schema).
- Otherwise, interactive selection.

---

## Implementation Notes
- Prefer shelling out to `gh auth token` first:
  - `gh auth token --hostname github.com` (or default)
  - fallback to env
- Keep a `context.Context` through API calls; cancel on quit.
- All API calls should be isolated in `internal/gh`.
- UI should never crash on partial/null data.

---

## Prompt to Coding Agent (Codex)
Implement the above MVP in Go. Use Bubble Tea + Bubbles + Lip Gloss for the UI. Use GitHub GraphQL API (Projects v2) for all data operations. Focus on correctness, a clean state machine, and robust handling of dynamic project schemas and item content unions. Ensure “move” updates the chosen SINGLE_SELECT field via mutation with optimistic UI + rollback on errors. Include pagination and a manual refresh. Provide a README and basic unit tests for grouping logic and group-field selection. Keep API queries thin and avoid fetching all field values.
